apiVersion: v1
data:
  01-restore.sql: "-- Create the database outside the transaction for compatibility\nCREATE DATABASE IF NOT EXISTS cinema;\nUSE cinema;\n\nSTART TRANSACTION;\n\nCREATE TABLE movies (\n  movie_id INT PRIMARY KEY AUTO_INCREMENT,\n  title VARCHAR(100) NOT NULL,\n  duration_minutes INT NOT NULL,\n  genre VARCHAR(50),\n  description TEXT\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\nCREATE TABLE halls (\n  hall_id INT PRIMARY KEY AUTO_INCREMENT,\n  name VARCHAR(50) NOT NULL,\n  total_seats INT NOT NULL\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\nCREATE TABLE seats (\n  seat_id INT PRIMARY KEY AUTO_INCREMENT,\n  hall_id INT NOT NULL,\n  seat_row CHAR(1) NOT NULL,\n  seat_number INT NOT NULL,\n  seat_type ENUM('reduced', 'normal', 'premium') NOT NULL,\n  FOREIGN KEY (hall_id) REFERENCES halls(hall_id) ON DELETE CASCADE\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\nCREATE TABLE screenings (\n  screening_id INT PRIMARY KEY AUTO_INCREMENT,\n  movie_id INT NOT NULL,\n  hall_id INT NOT NULL,\n  start_time DATETIME NOT NULL,\n  FOREIGN KEY (movie_id) REFERENCES movies(movie_id) ON DELETE CASCADE,\n  FOREIGN KEY (hall_id) REFERENCES halls(hall_id) ON DELETE CASCADE\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\nCREATE TABLE users (\n  user_id INT PRIMARY KEY AUTO_INCREMENT,\n  username VARCHAR(50) NOT NULL UNIQUE,\n  email VARCHAR(100),\n  password_hash VARCHAR(255) NOT NULL,\n  role ENUM('user', 'manager') NOT NULL DEFAULT 'user'\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\nCREATE TABLE reservations (\n  reservation_id INT PRIMARY KEY AUTO_INCREMENT,\n  user_id INT NOT NULL,\n  screening_id INT NOT NULL,\n  seat_id INT NOT NULL,\n  reservation_time DATETIME DEFAULT CURRENT_TIMESTAMP,\n  FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,\n  FOREIGN KEY (screening_id) REFERENCES screenings(screening_id) ON DELETE CASCADE,\n  FOREIGN KEY (seat_id) REFERENCES seats(seat_id) ON DELETE CASCADE,\n  UNIQUE (screening_id, seat_id)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- Dummy Data\n\n-- Movies\nINSERT INTO movies (title, duration_minutes, genre, description) VALUES\n('Inception', 148, 'Sci-Fi', 'A thief steals corporate secrets through dream-sharing.'),\n('The Godfather', 175, 'Crime', 'Mafia family drama.'),\n('Interstellar', 169, 'Sci-Fi', 'Space travel to save humanity.'),\n('Spirited Away', 125, 'Animation', 'A young'),\n('Pulp Fiction', 154, 'Crime', 'Interconnected stories of crime.'),\n('The Matrix', 136, 'Sci-Fi', 'A hacker discovers reality is a simulation.');\n\n-- Halls\nINSERT INTO halls (name, total_seats) VALUES\n('Main Hall A', 50),\n('Main Hall B', 30), \n('Main Hall C', 75),      \n('VIP Lounge A', 20),\n('VIP Lounge B', 10);   \n\n-- Seats (Main Hall A: A-C rows, seats 1-5) - Hall ID 1\nINSERT INTO seats (hall_id, seat_row, seat_number, seat_type) VALUES\n(1, 'A', 1, 'normal'), (1, 'A', 2, 'normal'), (1, 'A', 3, 'normal'),\n(1, 'A', 4, 'normal'), (1, 'A', 5, 'normal'),\n(1, 'B', 1, 'reduced'), (1, 'B', 2, 'reduced'), (1, 'B', 3, 'reduced'),\n(1, 'B', 4, 'reduced'), (1, 'B', 5, 'reduced'),\n(1, 'C', 1, 'premium'), (1, 'C', 2, 'premium'), (1, 'C', 3, 'premium'),\n(1, 'C', 4, 'premium'), (1, 'C', 5, 'premium');\n\n-- Seats (Screening Room 3: A-C rows, seats 1-10) - Hall ID 2\nINSERT INTO seats (hall_id, seat_row, seat_number, seat_type) VALUES\n(2, 'A', 1, 'normal'), (2, 'A', 2, 'normal'), (2, 'A', 3, 'normal'), (2, 'A', 4, 'normal'), (2, 'A', 5, 'normal'),\n(2, 'A', 6, 'normal'), (2, 'A', 7, 'normal'), (2, 'A', 8, 'normal'), (2, 'A', 9, 'normal'), (2, 'A', 10, 'normal'),\n(2, 'B', 1, 'normal'), (2, 'B', 2, 'normal'), (2, 'B', 3, 'normal'), (2, 'B', 4, 'normal'), (2, 'B', 5, 'normal'),\n(2, 'B', 6, 'normal'), (2, 'B', 7, 'normal'), (2, 'B', 8, 'normal'), (2, 'B', 9, 'normal'), (2, 'B', 10, 'normal'),\n(2, 'C', 1, 'reduced'), (2, 'C', 2, 'reduced'), (2, 'C', 3, 'reduced'), (2, 'C', 4, 'reduced'), (2, 'C', 5, 'reduced'),\n(2, 'C', 6, 'reduced'), (2, 'C', 7, 'reduced'), (2, 'C', 8, 'reduced'), (2, 'C', 9, 'reduced'), (2, 'C', 10, 'reduced');\n\n-- Seats (Theater 4: A-C rows, seats 1-15) - Hall ID 3\nINSERT INTO seats (hall_id, seat_row, seat_number, seat_type) VALUES\n(3, 'A', 1, 'normal'), (3, 'A', 2, 'normal'), (3, 'A', 3, 'normal'), (3, 'A', 4, 'normal'), (3, 'A', 5, 'normal'),\n(3, 'A', 6, 'normal'), (3, 'A', 7, 'normal'), (3, 'A', 8, 'normal'), (3, 'A', 9, 'normal'), (3, 'A', 10, 'normal'),\n(3, 'A', 11, 'normal'), (3, 'A', 12, 'normal'), (3, 'A', 13, 'normal'), (3, 'A', 14, 'normal'), (3, 'A', 15, 'normal'),\n(3, 'B', 1, 'normal'), (3, 'B', 2, 'normal'), (3, 'B', 3, 'normal'), (3, 'B', 4, 'normal'), (3, 'B', 5, 'normal'),\n(3, 'B', 6, 'normal'), (3, 'B', 7, 'normal'), (3, 'B', 8, 'normal'), (3, 'B', 9, 'normal'), (3, 'B', 10, 'normal'),\n(3, 'B', 11, 'normal'), (3, 'B', 12, 'normal'), (3, 'B', 13, 'normal'), (3, 'B', 14, 'normal'), (3, 'B', 15, 'normal'),\n(3, 'C', 1, 'premium'), (3, 'C', 2, 'premium'), (3, 'C', 3, 'premium'), (3, 'C', 4, 'premium'), (3, 'C', 5, 'premium'),\n(3, 'C', 6, 'premium'), (3, 'C', 7, 'premium'), (3, 'C', 8, 'premium'), (3, 'C', 9, 'premium'), (3, 'C', 10, 'premium');\n\n-- Seats (VIP Lounge A: row A, seats 1-4) - Hall ID 4\nINSERT INTO seats (hall_id, seat_row, seat_number, seat_type) VALUES\n(4, 'A', 1, 'premium'), (4, 'A', 2, 'premium'),\n(4, 'A', 3, 'premium'), (4, 'A', 4, 'premium');\n\n-- Seats (Private Booth 5: A row, seats 1-10) - Hall ID 5\nINSERT INTO seats (hall_id, seat_row, seat_number, seat_type) VALUES\n(5, 'A', 1, 'premium'), (5, 'A', 2, 'premium'), (5, 'A', 3, 'premium'), (5, 'A', 4, 'premium'), (5, 'A', 5, 'premium'),\n(5, 'A', 6, 'premium'), (5, 'A', 7, 'premium'), (5, 'A', 8, 'premium'), (5, 'A', 9, 'premium'), (5, 'A', 10, 'premium');\n\n-- Screenings\nINSERT INTO screenings (movie_id, hall_id, start_time) VALUES\n(1, 1, '2025-05-05 18:00:00'),\n(2, 1, '2025-05-05 21:00:00'),\n(3, 2, '2025-05-06 20:00:00'),\n(4, 3, '2025-06-05 16:30:00'), \n(5, 4, '2025-06-05 19:00:00'), \n(6, 5, '2025-06-06 22:00:00');\n\n-- Users\nINSERT INTO users (username, email, password_hash, role) VALUES\n('alice', 'alice@example.com', '$2b$10$examplehashforalice...', 'user'),\n('bob', 'bob@example.com', '$2b$10$examplehashforbob...', 'manager');\n\n-- Reservations\nINSERT INTO reservations (user_id, screening_id, seat_id) VALUES\n(1, 1, 1),    -- Alice books seat A1 for Inception\n(2, 1, 2),    -- Bob books seat A2 for Inception\n(1, 3, 16);   -- Alice books seat A4 in VIP for Interstellar\n\nCOMMIT;"
  02-makeUser.sql: |-
    CREATE USER 'webuser'@'%' IDENTIFIED BY 'webuserPass';
    GRANT ALL PRIVILEGES ON cinema.* TO 'webuser'@'%';
    FLUSH PRIVILEGES;
  03-addManager.sql: |-
    USE cinema;
    -- add manager
    INSERT INTO Users (username, password_hash, email, role)
    VALUES ('manager', '$2b$10$q4ap1kUA5layH4N1WRZH9ubpz9oLS1n3pwW4vaq7hKdTlzUEqlQI2', 'manager@cinema.com', 'manager');
kind: ConfigMap
metadata:
  labels:
    io.kompose.service: db
  name: db-cm0
